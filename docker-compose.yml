services:
  # ── Reverse Proxy ─────────────────────────────────────────────
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "8001:8001"
      - "8002:8002"
      - "8003:8003"
      - "8004:8004"
      - "8005:8005"
      - "8006:8006"
      - "8007:8007"
      - "8008:8008"
      - "8009:8009"
      - "8010:8010"
      - "8011:8011"
      - "8012:8012"
      - "8013:8013"
      - "8014:8014"
      - "8015:8015"
      - "8016:8016"
      - "8017:8017"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    mem_limit: 64m

  # ── RamblingRadio ─────────────────────────────────────────────
  ramblingradio:
    image: 216labs/ramblingradio:latest
    build: ./RamblingRadio
    restart: unless-stopped
    environment:
      - PORT=5000
      - NODE_ENV=production
      - DATABASE_URL=${RAMBLINGRADIO_DATABASE_URL}
    expose:
      - "5000"
    depends_on:
      - postgres
    mem_limit: 256m

  # ── Stroll.live ───────────────────────────────────────────────
  stroll:
    image: 216labs/stroll:latest
    build: ./Stroll.live
    restart: unless-stopped
    environment:
      - PORT=5000
      - NODE_ENV=production
    expose:
      - "5000"
    mem_limit: 256m

  # ── OneRoom ───────────────────────────────────────────────────
  oneroom:
    image: 216labs/oneroom:latest
    build: ./oneroom
    restart: unless-stopped
    environment:
      - PORT=3000
      - NODE_ENV=production
    expose:
      - "3000"
    mem_limit: 256m

  # ── OneFit ────────────────────────────────────────────────────
  onefit:
    image: 216labs/onefit:latest
    build: ./onefit
    restart: unless-stopped
    environment:
      - PORT=3000
      - NODE_ENV=production
    expose:
      - "3000"
    mem_limit: 256m

  # ── Paperframe (frontend only on small VPS) ──────────────────
  paperframe-frontend:
    image: 216labs/paperframe-frontend:latest
    build: ./paperframe/frontend
    restart: unless-stopped
    environment:
      - PORT=3000
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${PAPERFRAME_API_URL:-}
    expose:
      - "3000"
    mem_limit: 256m

  # ── HiveFind ─────────────────────────────────────────────────
  hivefind:
    image: 216labs/hivefind:latest
    build: ./hivefind
    restart: unless-stopped
    environment:
      - PORT=3000
      - NODE_ENV=production
    expose:
      - "3000"
    mem_limit: 256m

  # ── PipeSecure ───────────────────────────────────────────────
  pipesecure:
    image: 216labs/pipesecure:latest
    build: ./pipesecure
    restart: unless-stopped
    environment:
      - PORT=3000
      - NODE_ENV=production
      - DATABASE_URL=${PIPESECURE_DATABASE_URL}
      - REDIS_URL=redis://redis:6379
      - NEXTAUTH_URL=${PIPESECURE_NEXTAUTH_URL:-http://localhost:8006}
      - NEXTAUTH_SECRET=${PIPESECURE_NEXTAUTH_SECRET}
      - AUTH_TRUST_HOST=true
      - GITHUB_CLIENT_ID=${PIPESECURE_GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${PIPESECURE_GITHUB_CLIENT_SECRET:-}
      - GITHUB_APP_ID=${PIPESECURE_GITHUB_APP_ID:-}
      - GITHUB_APP_PRIVATE_KEY_PATH=/app/github-app-private-key.pem
      - GITHUB_WEBHOOK_SECRET=${PIPESECURE_GITHUB_WEBHOOK_SECRET:-}
      - ENCRYPTION_KEY=${PIPESECURE_ENCRYPTION_KEY:-}
      - NEXT_PUBLIC_APP_URL=${PIPESECURE_NEXT_PUBLIC_APP_URL:-http://localhost:8006}
    volumes:
      - ./pipesecure/github-app-private-key.pem:/app/github-app-private-key.pem:ro
    expose:
      - "3000"
    depends_on:
      postgres:
        condition: service_started
      redis:
        condition: service_started
      pipesecure-migrate:
        condition: service_completed_successfully
    mem_limit: 256m

  pipesecure-worker:
    image: 216labs/pipesecure-worker:latest
    build:
      context: ./pipesecure
      dockerfile: Dockerfile.worker
    restart: unless-stopped
    environment:
      - DATABASE_URL=${PIPESECURE_DATABASE_URL}
      - REDIS_URL=redis://redis:6379
      - GITHUB_APP_ID=${PIPESECURE_GITHUB_APP_ID:-}
      - GITHUB_APP_PRIVATE_KEY_PATH=/app/github-app-private-key.pem
      - GITHUB_WEBHOOK_SECRET=${PIPESECURE_GITHUB_WEBHOOK_SECRET:-}
      - ENCRYPTION_KEY=${PIPESECURE_ENCRYPTION_KEY:-}
    volumes:
      - ./pipesecure/github-app-private-key.pem:/app/github-app-private-key.pem:ro
    depends_on:
      postgres:
        condition: service_started
      redis:
        condition: service_started
      pipesecure-migrate:
        condition: service_completed_successfully
    mem_limit: 512m

  pipesecure-migrate:
    image: 216labs/pipesecure-worker:latest
    build:
      context: ./pipesecure
      dockerfile: Dockerfile.worker
    environment:
      - DATABASE_URL=${PIPESECURE_DATABASE_URL}
    command: npx prisma db push --skip-generate
    depends_on:
      - postgres
    restart: "no"

  # ── 216labs Admin Dashboard ─────────────────────────────────
  admin:
    image: 216labs/admin:latest
    build: ./216labs_admin
    restart: unless-stopped
    environment:
      - PORT=3000
      - NODE_ENV=production
      - DATABASE_PATH=/app/216labs.db
      - PROJECTS_ROOT=/workspace
      - NEXT_PUBLIC_APP_HOST=${APP_HOST:-46.101.88.197}
    volumes:
      - ./216labs.db:/app/216labs.db
      - ./:/workspace:ro
      - /var/run/docker.sock:/var/run/docker.sock
    expose:
      - "3000"
    mem_limit: 128m

  # ── AGI Memes ────────────────────────────────────────────────
  agimemes:
    image: 216labs/agimemes:latest
    build: ./agimemes.com
    restart: unless-stopped
    environment:
      - PORT=5000
      - NEWS_API_KEY=${AGIMEMES_NEWS_API_KEY:-}
      - IMG_FLIP_USERNAME=${AGIMEMES_IMG_FLIP_USERNAME:-}
      - IMG_FLIP_PASSWORD=${AGIMEMES_IMG_FLIP_PASSWORD:-}
    expose:
      - "5000"
    mem_limit: 128m

  # ── Priors ───────────────────────────────────────────────────
  priors:
    image: 216labs/priors:latest
    build: ./priors
    restart: unless-stopped
    environment:
      - PORT=5000
      - PRIORS_DATABASE_PATH=/app/data/database.db
      - PRIORS_SECRET_KEY=${PRIORS_SECRET_KEY:-change-me}
      - PRIORS_GOOGLE_CLIENT_SECRETS_FILE=/app/client_secret.json
      - PRIORS_OAUTH_REDIRECT_URI=${PRIORS_OAUTH_REDIRECT_URI:-http://localhost:8010/callback}
      - GOOGLE_CLIENT_ID=${PRIORS_GOOGLE_CLIENT_ID:-}
      - GEMINI_API_KEY=${PRIORS_GEMINI_API_KEY:-}
    volumes:
      - ./priors/data:/app/data
      - ./priors/client_secret.json:/app/client_secret.json:ro
    expose:
      - "5000"
    mem_limit: 128m

  # ── Big Leroy's Premier League Guessing Bonanza ──────────────
  bigleroys:
    image: 216labs/bigleroys:latest
    build: ./bigleroys
    restart: unless-stopped
    environment:
      - PORT=5000
      - BIGLEROYS_SECRET_KEY=${BIGLEROYS_SECRET_KEY:-change-me}
      - BIGLEROYS_GOOGLE_CLIENT_SECRETS_FILE=/app/client_secret.json
      - BIGLEROYS_OAUTH_REDIRECT_URI=${BIGLEROYS_OAUTH_REDIRECT_URI:-http://localhost:8012/callback}
      - BIGLEROYS_GOOGLE_CLIENT_ID=${BIGLEROYS_GOOGLE_CLIENT_ID:-}
      - BIGLEROYS_DATABASE_PATH=/app/data/bigleroys.db
    volumes:
      - ./bigleroys/data:/app/data
      - ./bigleroys/client_secret.json:/app/client_secret.json:ro
    expose:
      - "5000"
    mem_limit: 256m

  # ── AgitShirts ────────────────────────────────────────────────
  agitshirts:
    image: 216labs/agitshirts:latest
    build: ./agitshirts
    restart: unless-stopped
    environment:
      - PORT=5000
      - AGITSHIRTS_OPENAI_API_KEY=${AGITSHIRTS_OPENAI_API_KEY:-}
      - AGITSHIRTS_MODEL=${AGITSHIRTS_MODEL:-gpt-4o-mini}
      - AGITSHIRTS_CHECKOUT_BASE_URL=${AGITSHIRTS_CHECKOUT_BASE_URL:-}
    expose:
      - "5000"
    mem_limit: 128m

  # ── Artisanal Europe ─────────────────────────────────────────
  artisinaleurope:
    image: 216labs/artisinaleurope:latest
    build: ./artisinaleurope
    restart: unless-stopped
    environment:
      - PORT=3000
      - NODE_ENV=production
    expose:
      - "3000"
    mem_limit: 256m

  # ── CalibratedAI ─────────────────────────────────────────────
  calibratedai:
    image: 216labs/calibratedai:latest
    build: ./calibratedai
    restart: unless-stopped
    environment:
      - PORT=3000
      - NODE_ENV=production
      - CALIBRATEDAI_OPENROUTER_API_KEY=${CALIBRATEDAI_OPENROUTER_API_KEY:-}
      - CALIBRATEDAI_DB_PATH=/app/data/calibratedai.db
    volumes:
      - ./calibratedai/data:/app/data
    expose:
      - "3000"
    mem_limit: 256m

  # ── 1PageResearch ────────────────────────────────────────────
  1pageresearch:
    image: 216labs/1pageresearch:latest
    build: ./1pageresearch
    restart: unless-stopped
    environment:
      - PORT=5000
      - ONEPAGE_OPENROUTER_API_KEY=${ONEPAGE_OPENROUTER_API_KEY:-}
      - ONEPAGE_MODEL=${ONEPAGE_MODEL:-google/gemini-2.0-flash-001}
      - ONEPAGE_DB_PATH=/app/data/1pageresearch.db
    volumes:
      - ./1pageresearch/data:/app/data
    expose:
      - "5000"
    mem_limit: 128m

  # ── The Zurich Dating Game ───────────────────────────────────
  thezurichdatinggame:
    image: 216labs/thezurichdatinggame:latest
    build: ./thezurichdatinggame
    restart: unless-stopped
    environment:
      - PORT=3000
      - NODE_ENV=production
      - ZDGAME_DB_PATH=/app/data/zdgame.db
      - ZDGAME_ADMIN_KEY=${ZDGAME_ADMIN_KEY:-change-me}
      - ZDGAME_OPENROUTER_API_KEY=${ZDGAME_OPENROUTER_API_KEY:-}
      - ZDGAME_MODEL=${ZDGAME_MODEL:-google/gemini-2.0-flash-001}
    volumes:
      - ./thezurichdatinggame/data:/app/data
    expose:
      - "3000"
    mem_limit: 256m

  # ── Redis (used by PipeSecure) ──────────────────────────────
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
    expose:
      - "6379"
    mem_limit: 64m

  # ── Paperframe ML backend ────────────────────────────────────
  # Requires ~2GB RAM. Enable with: docker compose --profile ml up -d
  paperframe-backend:
    image: 216labs/paperframe-backend:latest
    build: ./paperframe/backend
    restart: unless-stopped
    profiles:
      - ml
    environment:
      - SAM_CHECKPOINT=/models/sam_vit_b_01ec64.pth
      - SAM_MODEL_TYPE=vit_b
      - OMP_NUM_THREADS=1
    expose:
      - "8000"
    volumes:
      - sam_models:/models
    mem_limit: 2048m

  # ── Anchor ───────────────────────────────────────────────────
  anchor-api:
    image: 216labs/anchor-api:latest
    build: ./anchor/backend
    restart: unless-stopped
    environment:
      - ANCHOR_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-labs}:${POSTGRES_PASSWORD:-labs}@postgres:5432/anchor
      - ANCHOR_SECRET_KEY=${ANCHOR_SECRET_KEY:-change-me}
    expose:
      - "8000"
    depends_on:
      - postgres
    mem_limit: 256m

  anchor-web:
    image: 216labs/anchor-web:latest
    build: ./anchor/frontend
    restart: unless-stopped
    expose:
      - "80"
    mem_limit: 64m

  # ── Databases ─────────────────────────────────────────────────
  postgres:
    image: postgis/postgis:16-3.4-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-labs}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-labs}
      - POSTGRES_DB=${POSTGRES_DB:-ramblingradio}
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./pipesecure/init-db.sh:/docker-entrypoint-initdb.d/10-create-pipesecure-db.sh:ro
      - ./anchor/init-anchor-db.sh:/docker-entrypoint-initdb.d/20-create-anchor-db.sh:ro
    expose:
      - "5432"
    mem_limit: 256m

volumes:
  caddy_data:
  caddy_config:
  sam_models:
  pg_data:
  redis_data:
