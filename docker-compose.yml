services:
  # ── Reverse Proxy ─────────────────────────────────────────────
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "8001:8001"
      - "8002:8002"
      - "8003:8003"
      - "8004:8004"
      - "8005:8005"
      - "8006:8006"
      - "8007:8007"
      - "8008:8008"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    mem_limit: 64m

  # ── RamblingRadio ─────────────────────────────────────────────
  ramblingradio:
    image: 216labs/ramblingradio:latest
    build: ./RamblingRadio
    restart: unless-stopped
    environment:
      - PORT=5000
      - NODE_ENV=production
      - DATABASE_URL=${RAMBLINGRADIO_DATABASE_URL}
    expose:
      - "5000"
    depends_on:
      - postgres
    mem_limit: 256m

  # ── Stroll.live ───────────────────────────────────────────────
  stroll:
    image: 216labs/stroll:latest
    build: ./Stroll.live
    restart: unless-stopped
    environment:
      - PORT=5000
      - NODE_ENV=production
    expose:
      - "5000"
    mem_limit: 256m

  # ── OneFit ────────────────────────────────────────────────────
  onefit:
    image: 216labs/onefit:latest
    build: ./onefit
    restart: unless-stopped
    environment:
      - PORT=3000
      - NODE_ENV=production
    expose:
      - "3000"
    mem_limit: 256m

  # ── Paperframe (frontend only on small VPS) ──────────────────
  paperframe-frontend:
    image: 216labs/paperframe-frontend:latest
    build: ./paperframe/frontend
    restart: unless-stopped
    environment:
      - PORT=3000
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${PAPERFRAME_API_URL:-}
    expose:
      - "3000"
    mem_limit: 256m

  # ── HiveFind ─────────────────────────────────────────────────
  hivefind:
    image: 216labs/hivefind:latest
    build: ./hivefind
    restart: unless-stopped
    environment:
      - PORT=3000
      - NODE_ENV=production
    expose:
      - "3000"
    mem_limit: 256m

  # ── PipeSecure ───────────────────────────────────────────────
  pipesecure:
    image: 216labs/pipesecure:latest
    build: ./pipesecure
    restart: unless-stopped
    environment:
      - PORT=3000
      - NODE_ENV=production
      - DATABASE_URL=${PIPESECURE_DATABASE_URL}
      - REDIS_URL=redis://redis:6379
      - NEXTAUTH_URL=${PIPESECURE_NEXTAUTH_URL:-http://localhost:8006}
      - NEXTAUTH_SECRET=${PIPESECURE_NEXTAUTH_SECRET}
      - AUTH_TRUST_HOST=true
      - GITHUB_CLIENT_ID=${PIPESECURE_GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${PIPESECURE_GITHUB_CLIENT_SECRET:-}
      - GITHUB_APP_ID=${PIPESECURE_GITHUB_APP_ID:-}
      - GITHUB_APP_PRIVATE_KEY_PATH=/app/github-app-private-key.pem
      - GITHUB_WEBHOOK_SECRET=${PIPESECURE_GITHUB_WEBHOOK_SECRET:-}
      - ENCRYPTION_KEY=${PIPESECURE_ENCRYPTION_KEY:-}
      - NEXT_PUBLIC_APP_URL=${PIPESECURE_NEXT_PUBLIC_APP_URL:-http://localhost:8006}
    volumes:
      - ./pipesecure/github-app-private-key.pem:/app/github-app-private-key.pem:ro
    expose:
      - "3000"
    depends_on:
      postgres:
        condition: service_started
      redis:
        condition: service_started
      pipesecure-migrate:
        condition: service_completed_successfully
    mem_limit: 256m

  pipesecure-worker:
    image: 216labs/pipesecure-worker:latest
    build:
      context: ./pipesecure
      dockerfile: Dockerfile.worker
    restart: unless-stopped
    environment:
      - DATABASE_URL=${PIPESECURE_DATABASE_URL}
      - REDIS_URL=redis://redis:6379
      - GITHUB_APP_ID=${PIPESECURE_GITHUB_APP_ID:-}
      - GITHUB_APP_PRIVATE_KEY_PATH=/app/github-app-private-key.pem
      - GITHUB_WEBHOOK_SECRET=${PIPESECURE_GITHUB_WEBHOOK_SECRET:-}
      - ENCRYPTION_KEY=${PIPESECURE_ENCRYPTION_KEY:-}
    volumes:
      - ./pipesecure/github-app-private-key.pem:/app/github-app-private-key.pem:ro
    depends_on:
      postgres:
        condition: service_started
      redis:
        condition: service_started
      pipesecure-migrate:
        condition: service_completed_successfully
    mem_limit: 512m

  pipesecure-migrate:
    image: 216labs/pipesecure-worker:latest
    build:
      context: ./pipesecure
      dockerfile: Dockerfile.worker
    environment:
      - DATABASE_URL=${PIPESECURE_DATABASE_URL}
    command: npx prisma db push --skip-generate
    depends_on:
      - postgres
    restart: "no"

  # ── 216labs Admin Dashboard ─────────────────────────────────
  admin:
    image: 216labs/admin:latest
    build: ./216labs_admin
    restart: unless-stopped
    environment:
      - PORT=3000
      - NODE_ENV=production
      - DATABASE_PATH=/app/216labs.db
    volumes:
      - ./216labs.db:/app/216labs.db
    expose:
      - "3000"
    mem_limit: 128m

  # ── AGI Memes ────────────────────────────────────────────────
  agimemes:
    image: 216labs/agimemes:latest
    build: ./agimemes.com
    restart: unless-stopped
    environment:
      - PORT=5000
      - NEWS_API_KEY=${AGIMEMES_NEWS_API_KEY:-}
      - IMG_FLIP_USERNAME=${AGIMEMES_IMG_FLIP_USERNAME:-}
      - IMG_FLIP_PASSWORD=${AGIMEMES_IMG_FLIP_PASSWORD:-}
    expose:
      - "5000"
    mem_limit: 128m

  # ── Redis (used by PipeSecure) ──────────────────────────────
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
    expose:
      - "6379"
    mem_limit: 64m

  # ── Paperframe ML backend ────────────────────────────────────
  # Requires ~2GB RAM. Enable with: docker compose --profile ml up -d
  paperframe-backend:
    image: 216labs/paperframe-backend:latest
    build: ./paperframe/backend
    restart: unless-stopped
    profiles:
      - ml
    environment:
      - SAM_CHECKPOINT=/models/sam_vit_b_01ec64.pth
      - SAM_MODEL_TYPE=vit_b
      - OMP_NUM_THREADS=1
    expose:
      - "8000"
    volumes:
      - sam_models:/models
    mem_limit: 2048m

  # ── Databases ─────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-labs}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-labs}
      - POSTGRES_DB=${POSTGRES_DB:-ramblingradio}
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./pipesecure/init-db.sh:/docker-entrypoint-initdb.d/create-pipesecure-db.sh:ro
    expose:
      - "5432"
    mem_limit: 128m

volumes:
  caddy_data:
  caddy_config:
  sam_models:
  pg_data:
  redis_data:
