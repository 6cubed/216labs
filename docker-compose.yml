services:
  # ── Reverse Proxy ─────────────────────────────────────────────
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - ramblingradio
      - stroll
      - onefit
      - paperframe-frontend
    mem_limit: 64m

  # ── RamblingRadio ─────────────────────────────────────────────
  ramblingradio:
    image: ghcr.io/6cubed/216labs/ramblingradio:latest
    build: ./RamblingRadio
    restart: unless-stopped
    environment:
      - PORT=5000
      - NODE_ENV=production
      - DATABASE_URL=${RAMBLINGRADIO_DATABASE_URL}
    expose:
      - "5000"
    depends_on:
      - postgres
    mem_limit: 256m

  # ── Stroll.live ───────────────────────────────────────────────
  stroll:
    image: ghcr.io/6cubed/216labs/stroll:latest
    build: ./Stroll.live
    restart: unless-stopped
    environment:
      - PORT=5000
      - NODE_ENV=production
    expose:
      - "5000"
    mem_limit: 256m

  # ── OneFit ────────────────────────────────────────────────────
  onefit:
    image: ghcr.io/6cubed/216labs/onefit:latest
    build: ./onefit
    restart: unless-stopped
    environment:
      - PORT=3000
      - NODE_ENV=production
    expose:
      - "3000"
    mem_limit: 256m

  # ── Paperframe (frontend only on small VPS) ──────────────────
  paperframe-frontend:
    image: ghcr.io/6cubed/216labs/paperframe-frontend:latest
    build: ./paperframe/frontend
    restart: unless-stopped
    environment:
      - PORT=3000
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${PAPERFRAME_API_URL:-}
    expose:
      - "3000"
    mem_limit: 256m

  # ── Paperframe ML backend ────────────────────────────────────
  # Requires ~2GB RAM for SAM + BLIP models.
  # Excluded from default profile — enable with:
  #   docker compose --profile ml up -d
  paperframe-backend:
    image: ghcr.io/6cubed/216labs/paperframe-backend:latest
    build: ./paperframe/backend
    restart: unless-stopped
    profiles:
      - ml
    environment:
      - SAM_CHECKPOINT=/models/sam_vit_b_01ec64.pth
      - SAM_MODEL_TYPE=vit_b
      - OMP_NUM_THREADS=1
    expose:
      - "8000"
    volumes:
      - sam_models:/models
    mem_limit: 2048m

  # ── Databases ─────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-labs}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-labs}
      - POSTGRES_DB=${POSTGRES_DB:-ramblingradio}
    volumes:
      - pg_data:/var/lib/postgresql/data
    expose:
      - "5432"
    mem_limit: 128m

volumes:
  caddy_data:
  caddy_config:
  sam_models:
  pg_data:
